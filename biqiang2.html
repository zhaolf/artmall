<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title></title>
  <link href="css/mui.min.css" rel="stylesheet" />
  <link href="css/common.css" rel="stylesheet" />
  <link href="css/biqiang.css" rel="stylesheet" />
  <script src="js/mui.min.js"></script>
  <style type="text/css">
  .bg {
    text-align: center;
    font-size: 14px;
    color: #b6b6b6;
    background-color: #f4f4f4;
    position: relative;
    overflow: hidden;
  }
  
  .btn-upload,
  .btn-choice,
  .btn-submit {
    position: relative;
    width: 119px;
    height: 39px;
    border: 1px solid #333;
    color: #333;
    line-height: 26px;
  }

  .btn-submit {
    display: none;
    margin: 20px auto;
    width: 100%;
  }
  
  .btn-choice a {
    color: #333;
  }
  
  #upfile {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    top: 0;
    opacity: 0;
  }
  
  .bar-input input::-webkit-input-placeholder {
    color: #666;
  }
  
  .bar-input input {
    border: none;
    border-bottom: 1px solid #ececec;
    color: #666;
    margin-bottom: 0;
    font-size: 14px;
  }
  
  .btn-bar {
    /*margin-top: 30px;*/
    margin-bottom: 20px;
  }
  
  #scroll {
    margin-top: 90px;
  }
  
  .banhua {
    text-align: center;
    margin: 0 5px;
  }
  
  .banhua h4 {
    text-align: left;
    font-size: 15px;
    line-height: 1em;
    color: #000;
    font-weight: normal;
    margin: 12px 0 8px;
  }
  
  .banhua p {
    text-align: left;
    font-size: 13px;
    line-height: 1em;
    color: #939393;
  }
  
  .banhua-cover {
    border: 1px solid #dfdfdf;
    padding: 20px 15px;
    /*display: inline-block;*/
  }
  
  .banhua-pic {
    height: 100%;
  }
  .bg{
  	height: 320px;
  	line-height: 320px;
  } 
  .bg div {
    position: absolute;
    left: 50%;
    margin-left: -56px;
    top: 25%;
  }
  .bg div .icon{
  	position: absolute;
  	width: 16px;
  	height: 16px;
  }
	.icon-close{
		background: url('img/ic_close.png') no-repeat;
		background-size: cover;
		left: -6px;
  	top: -6px;
	}
	.icon-circle{
		background: url('img/ic_circle.png') no-repeat;
		background-size: cover;
		right: -6px;
		bottom: -6px;
	}
  .btn-more{
    width: 300px;
    background: #F8F8F8;
    color: #B8B8B8;
    margin: 10px auto;
    height: 42px;
    line-height: 42px;
    text-align: center;
    cursor: pointer;
    border: none;
    display: block;
    padding: 0;
  }
  </style>
</head>

<body>
  <!-- <header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">PK吧，版画!</h1>
    <a class="mui-icon mui-pull-right btn-submit">保存并预览</a>
  </header> -->
  <audio src="mp3/bgm.mp3" autoplay loop></audio>
  <div class="mui-content">
    <div class="bg">
      <p>暂无预览</p>
      <!-- <img src="" id="target"> -->
      <!-- <div id="target">
      	<i class="icon icon-close"></i>
      	<i class="icon icon-circle"></i>
      </div> -->
    </div>
    <div style="padding:20px 36px;">
      <div class="btn-bar">
        <button class="btn-upload">
          上传室内照片
          <input type="file" name="" id="upfile">
        </button>
        <a href="javascript:void(0)" class="mui-btn btn-choice mui-pull-right">选择版画</a>
      </div>
      <div class="bar-input">
        <input type="text" name="author" placeholder="作者">
        <input type="text" name="workname" placeholder="作品名称">
        <input type="tel" name="phone" placeholder="联系电话">
      </div>
      <button class="btn-submit">保存并预览</button>
    </div>
    <div id="banhua" class="mui-popover mui-popover-action mui-popover-bottom">
      <div class="mui-content">
        <a href="#banhua"></a>
        <header class="mui-bar mui-bar-nav">
          <a class="mui-icon mui-icon-arrowdown mui-pull-left" href="#banhua"></a>
          <h1 class="mui-title">选择版画</h1>
        </header>
        <div class="mui-content" style="position: fixed;bottom: 0;top: 0;left: 0;right: 0;">
          <div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
            <div class="mui-scroll">
              <a class="mui-control-item mui-active" href="#bgs">
			            办公室
				        </a>
              <a class="mui-control-item" href="#ct">
				          餐厅
				        </a>
              <a class="mui-control-item" href="#kt">
				          客厅
				        </a>
              <a class="mui-control-item" href="#sf">
				          书房
				        </a>
              <a class="mui-control-item" href="#ws">
			          	卧室
				        </a>
              <a class="mui-control-item" href="#xg">
			            玄关
				        </a>
            </div>
          </div>
          <!-- <div> -->
          <div id="scroll" class="mui-scroll-wrapper">
            <div class="mui-scroll">
              <div id="bgs" class="mui-control-content mui-row mui-active" style="padding:10px 15px;">
              </div>
              <div id="ct" class="mui-control-content mui-row" style="padding:10px 15px;">
              </div>
              <div id="kt" class="mui-control-content mui-row" style="padding:10px 15px;">
              </div>
              <div id="sf" class="mui-control-content mui-row" style="padding:10px 15px;">
              </div>
              <div id="ws" class="mui-control-content mui-row" style="padding:10px 15px;">
              </div>
              <div id="xg" class="mui-control-content mui-row" style="padding:10px 15px;">
              </div>
              <button class="btn-more">查看更多</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <canvas id="myCanvas" style="display:none"></canvas>
  </div>
  <div class="ajax-loading">
    <div class="spinkit">
      <div class="rect1"></div>
      <div class="rect2"></div>
      <div class="rect3"></div>
      <div class="rect4"></div>
      <div class="rect5"></div>
    </div>
  </div>
</body>

</html>
<script type="text/x-tmpl" id="tmpl-bgs">
{% for (var i = 0; i< o.length; i++) { %} 
<div class="mui-col-xs-6">
  <div class="banhua" data-src="{%=o[i].picUrl%}">
    <div class="banhua-cover">
      <div class="banhua-pic" style="background-image:url({%=o[i].picUrl+'?imageMogr2/thumbnail/336'%});background-size:contain;background-position: center;background-repeat: no-repeat;"></div>
    </div>
    <h4 class="mui-ellipsis">{%=o[i].picName.split('-')[1]%}</h4>
    <p class="mui-ellipsis">作者：{%=o[i].picName.split('-')[0]%}</p>
  </div>
</div>
{% } %}
</script>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/tmpl.min.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script src="//cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
<script src="//cdn.bootcss.com/hammer.js/2.0.8/hammer.min.js"></script>
<script type="text/javascript" src="js/exif.min.js"></script>
<script type="text/javascript" charset="UTF-8">
var bgsJson = [],
  ctJson = [],
  ktJson = [],
  sfJson = [],
  wsJson = [],
  xgJson = [],index = 1,pageIndex = 1,i=1;
mui("#scroll").on('tap', '.banhua', function(event) {
  event.preventDefault();
  mui('#banhua').popover('toggle');
  $('.bg p').remove();
  $('.bg').append('<div id="target_'+index+'"><i class="icon icon-close"></i><i class="icon icon-circle" data-index="1"></i></div> ');
  // $('.bg').append('<div id="target_'+index+'"><i class="icon icon-close"></i></div> ');

  var img = new Image();
  img.setAttribute('crossOrigin','anonymous');
  img.src = $(this).data('src') + "?imageMogr2/thumbnail/336";
  img.onload = function(){
  	var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d"),picSrc=''; 
    canvas.width = img.width; 
    canvas.height = img.height; 
    ctx.clearRect(0, 0, canvas.width, canvas.height); 
    ctx.drawImage(img, 0, 0, img.width, img.height); 
    picSrc = canvas.toDataURL("image/png"); 
		$('#target_'+index).css({
	  	'width': img.width/3,
	  	'height': img.height/3,
	  	'background': 'url('+picSrc+') no-repeat center',
	  	'background-size': 'cover'
	  });
		var el = document.querySelector('#target_'+index);
	  initMove(el);
	  index++;
  };
  transform.angle = 0;
  // $('#target').attr('src', picSrc);
  
});
mui('#banhua').on('tap', '.mui-control-item', function(event) {
  event.preventDefault(); 
  $('.btn-more').hide();
  $($(this).attr('href')).empty();
  pageIndex = 1;
  getBanhua($(this).attr('href'),$(this).text().trim(),1);
});
mui('.bg').on('tap', '.icon-close', function(event) {
	$(this).parent('div').remove();
}).on('tap', '.icon-circle', function(event) {
  event.preventDefault();
  var temp = this.parentNode.style.transform;
  var i = $(this).data('index');
  temp = temp.split('rotate3d')[0]+'rotate3d(0, 0, 1, '+ 15*i +'deg)';
  transform.angle = 15*i;
  $(this).parent().css('transform', temp);
  $(this).data('index', i+1);
});
mui('.btn-bar').on('tap', '.btn-choice', function(event) {
  event.preventDefault();
  if ($('.bg p').length>0) {
    pTip('请先上传室内照片');
  }else{
    mui('#banhua').popover('toggle');
  }
});

mui(document).on('tap', '.btn-submit', function(event) {
	var author = $('input[name="author"]').val().trim();
	var workName = $('input[name="workname"]').val().trim();
	var phone = $('input[name="phone"]').val().trim();
	if (author==='') {
		pTip('请输入作者姓名');
		return;
	}
	if (workName==='') {
		pTip('请输入作品名称');
		return;
	}
	if (!/^1[3|4|5|8|7][0-9]\d{8}$/.test(phone)) {
		pTip('请输入合法手机号码');
		return;
	}
  $('input').blur();
  $('html,body').scrollTop(0).css('overflow', 'hidden');
  $('.ajax-loading').fadeIn();
	$('.icon').hide();
  html2canvas($('.bg'), {
    onrendered: function(canvas) {
      // document.body.appendChild(canvas);
      // $('.ajax-loading').fadeOut();
      $('.icon').show();
      $.ajax({
        url: biqiangBaseUrl+'/api/v1/user/0/compareWall/activity/addWork',
        type: 'POST',
        data: {
          'token': sessionStorage.getItem('token'),
          'baseString': canvas.toDataURL("image/png").split('base64,')[1],
          'author': author,
          'worksName': workName,
          'mobile': phone,
        },
        beforeSend: function(xhr){
          $('.btn-submit').attr('disabled', 'disabled');
        }
      })
      .done(function(data) {
        if (data.status == "200") {
          location.href="biqiang3.html?workId="+data.data;
        }
      })
      .always(function() {
        $('.btn-submit').removeAttr('disabled');
        $('.ajax-loading').fadeOut();
      });
    }
  });
  // html2canvas($('.bg')).then(function(canvas) {
    
		// // 
  // });
});
$(function() {
  $('.bg').height($(window).width()).css('line-height', $(window).width() + 'px');
  $('#banhua').height($(window).height());

  $('.btn-more').click(function(event) {
    var id = $('.mui-control-item.mui-active').attr('href');
    var name = $('.mui-control-item.mui-active').text().trim();
    pageIndex++;
    getBanhua(id,name,pageIndex);
  });

  getBanhua('#bgs','办公室',1);
});
var getBanhua = function(id,name,pageIndex){
  $.ajax({
    url: biqiangBaseUrl+'/api/v1/user/0/compareWall/activity/pictureList',
    data: {'picCategories':name,'token':sessionStorage.getItem('token'),pageIndex:pageIndex},
    beforeSend: function(xhr){
      $('.btn-more').attr('disabled', 'disabled');
    }
  })
  .done(function(data) {
    if (data.status == "200") {
      if (data.data.length===0&&$(id).find('.banhua').length===0) {
        $(id).empty().append('<p class="mui-text-center" style="margin-top:10px;color:#a7a7a7;clear:both">没有更多数据~</p>');
      }
      var temp = tmpl('tmpl-bgs', data.data);
      $(id).append(temp);
      if (data.data.length<10) {
        $('.btn-more').hide();
        if ($(id).find('.banhua').length>=10) {
          $(id).append('<p class="mui-text-center" style="margin-top:10px;color:#a7a7a7;clear:both">没有更多数据~</p>');
        }
      }else{
        $('.btn-more').show();
      }
      $('#scroll').height($(window).height() - 90);
      $('.banhua-cover').height($(window).width() / 2 - 66);
      mui('.mui-scroll-wrapper').scroll();
    }
  })
  .always(function(){
    $('.btn-more').removeAttr('disabled');
  });
};

var upfile = document.getElementById("upfile");
upfile.onchange = function(event) {
  var img = event.target.files[0];

  // if (img.size>(5*1024*1024)) {
  //   pTip('上传图片的尺寸上限为5M');
  //   return ;
  // };
  var Orientation = null;
  var reader = new FileReader();

  EXIF.getData(img, function() {  
   // console.log(EXIF.pretty(this));  
    EXIF.getAllTags(this);   
    //console.log(EXIF.getTag(this, 'Orientation'));   
    Orientation = EXIF.getTag(this, 'Orientation');  
    console.log(Orientation);
    //return;  
  }); 
  $('.ajax-loading').show();

  reader.readAsDataURL(img);
  reader.onload = function(e) {
    var image = new Image();  
    image.src = e.target.result;
    image.onload = function() {  
      var expectWidth = this.naturalWidth;  
      var expectHeight = this.naturalHeight;  
      var canvas = document.createElement("canvas");  
      var ctx = canvas.getContext("2d");  
      canvas.width = expectWidth;  
      canvas.height = expectHeight;  
      ctx.drawImage(this, 0, 0, expectWidth, expectHeight);


      if (navigator.userAgent.match(/iphone/i)) {  
        console.log('iphone');  
        //console.log(expectWidth + ',' + expectHeight);  
        //如果方向角不为1，都需要进行旋转 added by lzk  
        if(Orientation !== "" && Orientation != 1){  
          console.log('旋转处理');  
          switch(Orientation){  
          case 6://需要顺时针（向左）90度旋转  
            console.log('需要顺时针（向左）90度旋转');  
            rotateImg(this,'left',canvas);  
            break;  
          case 8://需要逆时针（向右）90度旋转  
            console.log('需要顺时针（向右）90度旋转');  
            rotateImg(this,'right',canvas);  
            break;  
          case 3://需要180度旋转  
            console.log('需要180度旋转');  
            rotateImg(this,'right',canvas);//转两次  
            rotateImg(this,'right',canvas);  
            break;  
          }         
        }  
        picUrl = canvas.toDataURL("image/png", 0.8);  
      }else{
        picUrl = e.target.result;
      }
      $('.ajax-loading').fadeOut();

      $('.btn-submit').show();
      $('.bg p').remove();
      $('.bg').css({
        'background': 'url(' + picUrl + ') no-repeat center center',
        'background-size': 'cover'
      });
    };
  };
};
function rotateImg(img, direction,canvas) {    
  //console.log(img);  
  //最小与最大旋转方向，图片旋转4次后回到原方向    
  var min_step = 0;    
  var max_step = 3;    
  //var img = document.getElementById(pid);    
  if (img === null)return;    
  //img的高度和宽度不能在img元素隐藏后获取，否则会出错    
  var height = img.height;    
  var width = img.width;    
  //var step = img.getAttribute('step');    
  var step = 2;    
  if (step === null) {    
      step = min_step;    
  }    
  if (direction == 'right') {    
      step++;    
      //旋转到原位置，即超过最大值    
      step > max_step && (step = min_step);    
  } else {    
      step--;    
      step < min_step && (step = max_step);    
  }    
  //img.setAttribute('step', step);    
  /*var canvas = document.getElementById('pic_' + pid);   
  if (canvas == null) {   
      img.style.display = 'none';   
      canvas = document.createElement('canvas');   
      canvas.setAttribute('id', 'pic_' + pid);   
      img.parentNode.appendChild(canvas);   
  }  */  
  //旋转角度以弧度值为参数    
  var degree = step * 90 * Math.PI / 180;    
  var ctx = canvas.getContext('2d');    
  switch (step) {    
      case 0:    
          canvas.width = width;    
          canvas.height = height;    
          ctx.drawImage(img, 0, 0);    
          break;    
      case 1:    
          canvas.width = height;    
          canvas.height = width;    
          ctx.rotate(degree);    
          ctx.drawImage(img, 0, -height);    
          break;    
      case 2: 
          canvas.width = width;    
          canvas.height = height;    
          ctx.rotate(degree);    
          ctx.drawImage(img, -width, -height);    
          break;    
      case 3:    
          canvas.width = height;    
          canvas.height = width;    
          ctx.rotate(degree);    
          ctx.drawImage(img, -width, 0);    
          break;    
    }    
}   

var transform;

// var el = document.querySelector("#target");
var initMove =function(el){
	//  图片拖拽、缩放
	var reqAnimationFrame = (function() {
	  return window[Hammer.prefixed(window, 'requestAnimationFrame')];
	})();

	var START_X = 0;
	var START_Y = 0;

	var ticking = false;
	var timer;
	var mc = new Hammer.Manager(el);
	mc.add(new Hammer.Pan({
	  threshold: 0,
	  pointers: 0
	}));
	mc.add(new Hammer.Swipe()).recognizeWith(mc.get('pan'));
	mc.add(new Hammer.Rotate({
	  threshold: 0
	})).recognizeWith(mc.get('pan'));
	mc.add(new Hammer.Pinch({
	  threshold: 0
	})).recognizeWith([mc.get('pan'), mc.get('rotate')]);
	var moveX = 0;
	var moveY = 0;
	mc.on("panstart", onPanstart);
	mc.on("panmove", onPanmove);
	// mc.on("rotatestart rotatemove", onRotate);
	mc.on("pinchstart pinchmove", onPinch);

	function resetElement() {
	  el.className = 'animate';
	  transform = {
	    translate: {
	      x: START_X,
	      y: START_Y
	    },
	    scale: 1,
	    angle: 0,
	    rx: 0,
	    ry: 0,
	    rz: 0
	  };
	  requestElementUpdate();
	}
	resetElement();

	function updateElementTransform() {
	  var value = [
	    'translate3d(' + transform.translate.x + 'px, ' + transform.translate.y + 'px, 0)',
	    'scale(' + transform.scale + ', ' + transform.scale + ')',
	    'rotate3d(' + 0 + ',' + 0 + ',' + 1 + ',' + transform.angle + 'deg)'
	  ];
	  value = value.join(" ");
	  el.style.webkitTransform = value;
	  el.style.mozTransform = value;
	  el.style.transform = value;
	  ticking = false;
	}

	function requestElementUpdate() {
	  if (!ticking) {
	    reqAnimationFrame(updateElementTransform);
	    ticking = true;
	  }
	}

	//
	var initScale = 1;

	function onPinch(ev) {
	  if (ev.type == 'pinchstart') {
	    initScale = transform.scale || 1;
	  }

	  el.className = '';
	  transform.scale = initScale * ev.scale;

	  requestElementUpdate();
	}

	var initAngle = 0;

	function onRotate(ev) {
	  if (ev.type == 'rotatestart') {
	    initAngle = transform.angle || 0;
	  }

	  el.className = '';
	  transform.rz = 1;
	  transform.angle = initAngle + ev.rotation;

	  requestElementUpdate();
	}

	var startx = 0;
	var starty = 0;
	var translateStr = '';

	function onPanstart(ev) {
	  str = el.style.webkitTransform; //translate(50px,0px)
    transform.scale = str.split('scale(')[1].split(',')[0];
    transform.angle = str.split(', ').pop().split('deg')[0];
	  startx = parseInt(str.match(/\-?[0-9]+/g)[1]);
	  starty = parseInt(str.match(/\-?[0-9]+/g)[2]);
	}

	function onPanmove(ev) {
	  var m = startx + ev.deltaX;
	  el.className = '';
	  var movex = startx + ev.deltaX;
	  var movey = starty + ev.deltaY;

	  transform.translate = {
	    x: movex,
	    y: movey
	  };

	  requestElementUpdate();
	}
};
</script>
